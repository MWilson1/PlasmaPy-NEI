# This file is here on a temporary visit from
# https://github.com/OpenAstronomy/azure-pipelines-templates/blob/127b156093f7e3c6bd939706a1ff5d6c9a3afdfd/run-tox-env.yml
# because we needed to solve LFS files not being pulled by Azure.
#
# The file is copyrighted by the wonderful SunPy Developers, on the following licence:
#    BSD 2-Clause License
#    
#    Copyright (c) 2019, The SunPy Developers
#    All rights reserved.
#    
#    Redistribution and use in source and binary forms, with or without
#    modification, are permitted provided that the following conditions are met:
#    
#    1. Redistributions of source code must retain the above copyright notice, this
#       list of conditions and the following disclaimer.
#    
#    2. Redistributions in binary form must reproduce the above copyright notice,
#       this list of conditions and the following disclaimer in the documentation
#       and/or other materials provided with the distribution.
#    
#    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
#    AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
#    IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
#    DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
#    FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
#    DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
#    SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
#    CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
#    OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
#    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#    

parameters:
  python_versions:
    - 3.7
    - 3.6
  npm_dir: "."

jobs:
- ${{ each target in parameters.targets }}:

  - ${{ if or(eq(target, 'wheels_macos'), eq(target, 'wheels_linux'), eq(target, 'wheels_windows')) }}:

    - job: ${{ target }}
      dependsOn: ${{ parameters.dependsOn }}
      condition: succeeded()

      variables:
        CIBW_TEST_COMMAND: ${{ parameters.test_command }}
        CIBW_TEST_EXTRAS: ${{ parameters.test_extras }}

      pool:
        ${{ if eq(target, 'wheels_macos') }}:
          vmImage: macos-latest
        ${{ if eq(target, 'wheels_linux') }}:
          vmImage: ubuntu-latest
        ${{ if eq(target, 'wheels_windows') }}:
          vmImage: windows-latest

      steps:
        - checkout: self
          lfs: true
          submodules: ${{ coalesce(parameters.submodules, true) }}
          fetchDepth: 999999999
        - ${{ if not(eq(target, 'wheels_windows')) }}:
          - task: UsePythonVersion@0
            inputs:
              versionSpec: ${{ parameters.python_versions[0] }}
        - ${{ if eq(target, 'wheels_windows') }}:
          - ${{ each version in parameters.python_versions }}:
            - task: UsePythonVersion@0
              inputs:
                versionSpec: ${{ version }}
        - bash: python -m pip install --upgrade pip
          displayName: Upgrading pip
        - bash: python -m pip install git+https://github.com/joerick/cibuildwheel.git
          displayName: Installing cibuildwheel
        - bash: cibuildwheel --output-dir wheelhouse .
          displayName: Running cibuildwheel
        - publish: 'wheelhouse'
          artifact: ${{ target }}

  - ${{ if eq(target, 'npm') }}:

    - job: ${{ target }}
      dependsOn: ${{ parameters.dependsOn }}
      condition: succeeded()

      pool:
        vmImage: ubuntu-latest

      steps:
        - checkout: self
          submodules: ${{ coalesce(parameters.submodules, true) }}
          fetchDepth: 999999999

        - task: Npm@1
          inputs:
            command: 'install'
            workingDir: ${{ parameters.npm_dir }}

  - ${{ if eq(target, 'sdist') }}:
    - job: ${{ target }}
      dependsOn: ${{ parameters.dependsOn }}
      condition: succeeded()
      pool:
        vmImage: 'Ubuntu-16.04'
      steps:
      - checkout: self
        submodules: ${{ coalesce(parameters.submodules, true) }}
        fetchDepth: 999999999
      - task: UsePythonVersion@0
        displayName: setup python3.7
        inputs:
          versionSpec: '3.7'
      - script: 'python -m pip install -U --user --force-reinstall pep517 setuptools_scm'
        displayName: "Install build tools"
      - script: 'python -m pep517.build --source --out-dir wheelhouse .'
        displayName: "Build source distribution"
      - ${{ if parameters.test_extras }}:
        - script: ${{ format('python -m pip install --force-reinstall $(find wheelhouse -name "*.tar.gz")[{0}]', parameters.test_extras) }}
          displayName: "Installing source distribution"
      - ${{ if not(parameters.test_extras) }}:
        - script: 'python -m pip install $(find wheelhouse -name "*.tar.gz")'
          displayName: "Installing source distribution"
      - ${{ if parameters.test_command }}:
        - script: ${{ parameters.test_command }}
          displayName: "Test source distribution"
          workingDirectory: $(Agent.TempDirectory)
      - publish: 'wheelhouse'
        artifact: ${{ target }}

  - ${{ if eq(target, 'wheels_universal') }}:
    - job: ${{ target }}
      dependsOn: ${{ parameters.dependsOn }}
      condition: succeeded()
      pool:
        vmImage: 'Ubuntu-16.04'
      steps:
      - checkout: self
        submodules: ${{ coalesce(parameters.submodules, true) }}
        fetchDepth: 999999999
      - task: UsePythonVersion@0
        displayName: setup python3.7
        inputs:
          versionSpec: '3.7'
      - script: 'python -m pip install -U --user --force-reinstall pep517 setuptools_scm'
        displayName: "Install build tools"
      - script: 'python -m pep517.build --binary --out-dir wheelhouse .'
        displayName: "Build universal wheel"
      - ${{ if parameters.test_extras }}:
        - script: ${{ format('python -m pip install --force-reinstall $(find wheelhouse -name "*.whl")[{0}]', parameters.test_extras) }}
          displayName: "Installing universal wheel"
      - ${{ if not(parameters.test_extras) }}:
        - script: 'python -m pip install $(find wheelhouse -name "*.whl")'
          displayName: "Installing universal wheel"
      - ${{ if parameters.test_command }}:
        - script: ${{ parameters.test_command }}
          displayName: "Test universal wheel"
          workingDirectory: $(Agent.TempDirectory)
      - publish: 'wheelhouse'
        artifact: ${{ target }}

- ${{ if coalesce(parameters.pypi_connection_name, parameters.artifact_feed) }}:
  - job: publish
    dependsOn: ${{ parameters.targets }}
    condition: succeeded()

    pool:
      vmImage: 'Ubuntu-16.04'

    steps:
    - checkout: none
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.7'
      displayName: Install Python 3.7
    - script: 'python -m pip install -U --user --force-reinstall twine'
      displayName: "install twine"
    # Get all artifacts from this build
    - ${{ each target in parameters.targets }}:
      - ${{ if ne(target, 'npm') }}:
        - task: DownloadPipelineArtifact@2
          inputs:
            buildType: 'current'
            targetPath: 'wheelhouse'
            artifactName: ${{ target }}

    - script: 'ls -R wheelhouse'

    - ${{ if parameters.pypi_connection_name }}:
      - task: TwineAuthenticate@1
        inputs:
          pythonUploadServiceConnection: ${{ parameters.pypi_connection_name}}
      - script:  ${{ format('python -m twine upload --skip-existing -r {0} --config-file $(PYPIRC_PATH) "wheelhouse/*"', coalesce(parameters.pypi_endpoint_name, parameters.pypi_connection_name)) }}
        displayName: "upload sdist and wheels to PyPI"

    - ${{ if parameters.artifact_feed }}:
      - task: TwineAuthenticate@1
        inputs:
          artifactFeeds: ${{ parameters.artifact_feed}}
      - script:  ${{ format('python -m twine upload --skip-existing -r {0} --config-file $(PYPIRC_PATH) "wheelhouse/*"', parameters.artifact_feed) }}
        displayName: "upload sdist and wheels to Artifacts feed"

- ${{ if parameters.npm_connection_name }}:
  - job: publish_npm
    dependsOn: ${{ parameters.targets }}
    condition: succeeded()
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - checkout: self
        submodules: ${{ coalesce(parameters.submodules, true) }}
        fetchDepth: 999999999
      - task: Npm@1
        inputs:
          command: 'install'
          workingDir: ${{ parameters.npm_dir }}
      - task: Npm@1
        inputs:
          command: 'publish'
          publishEndpoint: ${{ parameters.npm_connection_name}}
          workingDir: ${{ parameters.npm_dir }}
